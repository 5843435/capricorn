<% require 'rubygems' %>
<% require 'active_support' %>

<%- model_class = Stock -%>
<div class="page-header">
  <h1>マイページ</h1>
</div>
<% if @stocks.empty? %>
  <h4>在庫登録がありません。</h4>
<% else %>

  <h4>買い足し時期は?</h4>
<table class="table table-striped table-bordered table-hover table-condensed">
    <% week1 = [] %>
    <% week2 = [] %>
    <% week3 = [] %>
    <% week4 = [] %>
    <% week5 = [] %>
    <% @stocks.each do |stock| %>
    <% end_day =  calcEndday(stock) %> 
    <% if end_day <= Time.now %>
    <% elsif end_day < (Time.now + 1.week) %>
      <% week1[stock.id] = stock.item.name %>
    <% elsif ((Time.now + 1.week) <= end_day) && (end_day < (Time.now + 2.week)) %>
      <% week2[stock.id] = stock.item.name %>
    <% elsif ((Time.now + 2.week) <= end_day) && (end_day < (Time.now + 3.week)) %>
      <% week3[stock.id] = stock.item.name %>
    <% elsif ((Time.now + 3.week) <= end_day) && (end_day < (Time.now + 4.week)) %>
      <% week4[stock.id] = stock.item.name %>
    <% else %>
      <% week5[stock.id] = stock.item.name %>
    <% end %>
    <% end %>
    <tbody>
     <tr>
        <td>これから7日以内</td>
        <td><% week1.each do |name| %><%= name != nil ? name : "" %>  <% end %></td>
      </tr>
      <tr>
        <td>これから14日以内</td>
        <td><% week2.each do |name| %><%= name != nil ? name : "" %>  <% end %></td>
      </tr>
      <tr>
        <td>これから21日以内</td>
        <td><% week3.each do |name| %><%= name != nil ? name : "" %>  <% end %></td>
      </tr>
      <tr>
        <td>これから28日以内</td>
        <td><% week4.each do |name| %><%= name != nil ? name : "" %>  <% end %></td>
      </tr>
      <tr>
        <td>これから28日以降</td>
        <td><% week5.each do |name| %><%= name != nil ? name : "" %>  <% end %></td>
      </tr> 
    </tbody>
</table>

<table class="table table-striped">
  <thead>
    <tr>
      <th>商品名</th>
      <th>登録日</th>
      <th>なくなる日</th>
      <th>残量</th>
      <th><%=t '.actions', :default => t("helpers.actions") %></th>
    </tr>
  </thead>
  <tbody>
    <% @stocks.each do |stock| %>
      <% end_day =  calcEndday(stock) %> 
       <% remain_day = (( end_day - Time.now ) / ( 60 * 60 * 24 )).truncate %>
       <% if (( end_day - Time.now ) / ( 60 * 60 * 24 )).truncate < 0 %><% next %><% end %>
      <tr>
        <td><%= link_to stock.item.name, stock if stock.item %></td>
        <td><%= stock.updated_at.strftime("%Y年%m月%d日") %></td>
        <td><%= end_day.year %>年<%= end_day.month %>月<%= end_day.day %>日
          （あと<%= remain_day %>日）</td>
        <td>
      　  <% instance_div = stock.num.div(10) %>
          <% instance_div.times{ %>
          <img class="img-portfolio" width="50" height="50" src="/assets/icons/<%= stock.item.id %>_10.png">
          <% } %>
          <% instance_modulo = stock.num.modulo(10) %>
          <% instance_modulo.times { %>
          <img class="img-portfolio" width="30" height="30" src="/assets/icons/<%= stock.item.id %>.png">
          <% } %>
　　　　</td>
        <td>
          <%= link_to t('.edit', :default => t("helpers.links.edit")),
                      edit_stock_path(stock), :class => 'btn btn-xs btn-default' %>
          <%= link_to t('.destroy', :default => t("helpers.links.destroy")),
                      stock_path(stock),
                      :method => :delete,
                      :data => { :confirm => t('.confirm', :default => t("helpers.links.confirm", :default => '本当に削除しますか？')) },
                      :class => 'btn btn-xs btn-danger' %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
<% end %>

<%= link_to t('.new', :default => t("helpers.links.new")),
            new_stock_path,
            :class => 'btn btn-primary' %>
